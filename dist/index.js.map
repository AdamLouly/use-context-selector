{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import React from 'react';\r\n\r\n// utils\r\n\r\nconst forcedReducer = state => state + 1;\r\nconst useForceUpdate = () => React.useReducer(forcedReducer, 0)[1];\r\n\r\nconst calculateChangedBits = () => 0;\r\n\r\nconst identity = x => x;\r\n\r\nconst CONTEXT_LISTENERS = Symbol('CONTEXT_LISTENERS');\r\n\r\nconst createProvider = (OrigProvider, listeners) => React.memo(({ value, children }) => {\r\n  React.useLayoutEffect(() => {\r\n    listeners.forEach(listener => listener(value));\r\n  }, [value]);\r\n  return React.createElement(OrigProvider, { value }, children);\r\n});\r\n\r\n// createContext\r\n\r\nexport const createContext = (defaultValue) => {\r\n  const context = React.createContext(defaultValue, calculateChangedBits);\r\n  const listeners = new Set();\r\n  // shared listeners (not ideal)\r\n  context[CONTEXT_LISTENERS] = listeners;\r\n  // hacked provider\r\n  context.Provider = createProvider(context.Provider, listeners);\r\n  // no support for consumer\r\n  delete context.Consumer;\r\n  return context;\r\n};\r\n\r\n// useContextSelector\r\n\r\nexport const useContextSelector = (context, selector) => {\r\n  const listeners = context[CONTEXT_LISTENERS];\r\n  if (!listeners) {\r\n    throw new Error('useContextSelector requires special context');\r\n  }\r\n  const forceUpdate = useForceUpdate();\r\n  const value = React.useContext(context);\r\n  const selected = selector(value);\r\n  const ref = React.useRef(null);\r\n  React.useLayoutEffect(() => {\r\n    ref.current = { selector, value, selected };\r\n  });\r\n  React.useLayoutEffect(() => {\r\n    const callback = (nextValue) => {\r\n      try {\r\n        if (ref.current.value === nextValue\r\n          || Object.is(ref.current.selected, ref.current.selector(nextValue))) {\r\n          return;\r\n        }\r\n      } catch (e) {\r\n        // ignored (stale props or some other reason)\r\n      }\r\n      ref.current.value = nextValue;\r\n      forceUpdate();\r\n    };\r\n    listeners.add(callback);\r\n    return () => {\r\n      listeners.delete(callback);\r\n    };\r\n  }, [forceUpdate, listeners]);\r\n  return selected;\r\n};\r\n\r\n// useContext\r\n\r\nexport const useContext = context => useContextSelector(context, identity);\r\n"],"names":["const","forcedReducer","state","useForceUpdate","React","useReducer","calculateChangedBits","identity","x","CONTEXT_LISTENERS","Symbol","createProvider","OrigProvider","listeners","memo","children","useLayoutEffect","forEach","listener","value","createElement","createContext","defaultValue","context","Set","Provider","Consumer","useContextSelector","selector","Error","forceUpdate","useContext","selected","ref","useRef","current","callback","nextValue","Object","is","e","add","delete"],"mappings":";;AAIAA,IAAMC,aAAa,aAAGC,gBAASA,KAAK,GAAG,IAAvC;;AACAF,IAAMG,cAAc,wBAASC,KAAK,CAACC,UAAN,CAAiBJ,aAAjB,EAAgC,CAAhC,EAAmC,CAAnC,IAA7B;;AAEAD,IAAMM,oBAAoB,wBAAS,IAAnC;;AAEAN,IAAMO,QAAQ,aAAGC,YAAKA,IAAtB;;AAEAR,IAAMS,iBAAiB,GAAGC,MAAM,CAAC,mBAAD,CAAhC;;AAEAV,IAAMW,cAAc,aAAIC,YAAD,EAAeC,SAAf,WAA6BT,KAAK,CAACU,IAAN,WAAY,GAAD;wBAAUC;;;EACvEX,KAAK,CAACY,eAAN;IACEH,SAAS,CAACI,OAAV,WAAkBC,mBAAYA,QAAQ,CAACC,KAAD,IAAtC;GADF,EAEG,CAACA,KAAD,CAFH;SAGOf,KAAK,CAACgB,aAAN,CAAoBR,YAApB,EAAkC;WAAEO;GAApC,EAA6CJ,QAA7C,CAAP;CAJkD,IAApD;;;AASA,IAAaM,aAAa,aAAIC;MACtBC,OAAO,GAAGnB,KAAK,CAACiB,aAAN,CAAoBC,YAApB,EAAkChB,oBAAlC,CAAhB;MACMO,SAAS,GAAG,IAAIW,GAAJ,EAAlB,CAF6C;;EAI7CD,OAAO,CAACd,iBAAD,CAAP,GAA6BI,SAA7B,CAJ6C;;EAM7CU,OAAO,CAACE,QAAR,GAAmBd,cAAc,CAACY,OAAO,CAACE,QAAT,EAAmBZ,SAAnB,CAAjC,CAN6C;;SAQtCU,OAAO,CAACG,QAAf;SACOH,OAAP;CATK;;AAcP,IAAaI,kBAAkB,aAAIJ,OAAD,EAAUK,QAAV;MAC1Bf,SAAS,GAAGU,OAAO,CAACd,iBAAD,CAAzB;;MACI,CAACI,SAAL,EAAgB;UACR,IAAIgB,KAAJ,CAAU,6CAAV,CAAN;;;MAEIC,WAAW,GAAG3B,cAAc,EAAlC;MACMgB,KAAK,GAAGf,KAAK,CAAC2B,UAAN,CAAiBR,OAAjB,CAAd;MACMS,QAAQ,GAAGJ,QAAQ,CAACT,KAAD,CAAzB;MACMc,GAAG,GAAG7B,KAAK,CAAC8B,MAAN,CAAa,IAAb,CAAZ;EACA9B,KAAK,CAACY,eAAN;IACEiB,GAAG,CAACE,OAAJ,GAAc;gBAAEP,QAAF;aAAYT,KAAZ;gBAAmBa;KAAjC;GADF;EAGA5B,KAAK,CAACY,eAAN;QACQoB,QAAQ,aAAIC;UACZ;YACEJ,GAAG,CAACE,OAAJ,CAAYhB,KAAZ,KAAsBkB,SAAtB,IACCC,MAAM,CAACC,EAAP,CAAUN,GAAG,CAACE,OAAJ,CAAYH,QAAtB,EAAgCC,GAAG,CAACE,OAAJ,CAAYP,QAAZ,CAAqBS,SAArB,CAAhC,CADL,EACuE;;;OAFzE,CAKE,OAAOG,CAAP,EAAU;;;MAGZP,GAAG,CAACE,OAAJ,CAAYhB,KAAZ,GAAoBkB,SAApB;MACAP,WAAW;KAVb;;IAYAjB,SAAS,CAAC4B,GAAV,CAAcL,QAAd;;MAEEvB,SAAS,CAAC6B,MAAV,CAAiBN,QAAjB;KADF;GAdF,EAiBG,CAACN,WAAD,EAAcjB,SAAd,CAjBH;SAkBOmB,QAAP;CA9BK;;AAmCP,IAAaD,UAAU,aAAGR,kBAAWI,kBAAkB,CAACJ,OAAD,EAAUhB,QAAV,IAAhD;;;;"}
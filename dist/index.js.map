{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import React from 'react';\r\n\r\nconst CONTEXT_LISTENERS = Symbol('CONTEXT_LISTENERS');\r\n\r\nconst createProvider = (OrigProvider, listeners) => React.memo(({ value, children }) => {\r\n  // we call listeners in render intentionally.\r\n  // listeners are not technically pure, but\r\n  // otherwise we can't get benefits from concurrent mode.\r\n  // we make sure to work with double or more invocation of listeners.\r\n  listeners.some(listener => {\r\n    listener(value)\r\n  });\r\n  return React.createElement(OrigProvider, { value }, children);\r\n});\r\n\r\n// createContext\r\n\r\nexport const createContext = (defaultValue) => {\r\n  const context = React.createContext(defaultValue, () => 0);\r\n  // shared listeners (not ideal)\r\n  context[CONTEXT_LISTENERS] = new Set();\r\n  // hacked provider\r\n  context.Provider = createProvider(context.Provider, context[CONTEXT_LISTENERS]);\r\n  // no support for consumer\r\n  delete context.Consumer;\r\n  return context;\r\n};\r\n\r\n// useContextSelector\r\n\r\nexport const useContextSelector = (context, selector) => {\r\n  const listeners = context[CONTEXT_LISTENERS];\r\n  if (!listeners) {\r\n    throw new Error('useContextSelector requires special context');\r\n  }\r\n  const forceUpdate = React.useReducer(state => state + 1, 0)[1];\r\n  const value = React.useContext(context);\r\n  const selected = selector(value);\r\n  const ref = React.useRef(null);\r\n  React.useLayoutEffect(() => {\r\n    ref.current = { selector, value, selected };\r\n  });\r\n  React.useLayoutEffect(() => {\r\n    const callback = (nextValue) => {\r\n      try {\r\n        if (ref.current.value === nextValue\r\n          || Object.is(ref.current.selected, ref.current.selector(nextValue))) {\r\n          return;\r\n        }\r\n      } catch (e) {\r\n        // ignored (stale props or some other reason)\r\n      }\r\n      forceUpdate();\r\n    };\r\n    listeners.add(callback);\r\n    return () => {\r\n      listeners.delete(callback);\r\n    };\r\n  }, [forceUpdate, listeners]);\r\n  return selected;\r\n};\r\n\r\n// useContext\r\n\r\nexport const useContext = context => useContextSelector(context, x => x);\r\n"],"names":["CONTEXT_LISTENERS","Symbol","useContextSelector","context","selector","listeners","Error","forceUpdate","React","useReducer","state","value","useContext","selected","ref","useRef","useLayoutEffect","current","callback","nextValue","Object","is","e","add","delete","defaultValue","OrigProvider","createContext","Set","Provider","memo","children","some","listener","createElement","Consumer","x"],"mappings":"4EAEMA,EAAoBC,OAAO,qBA4BpBC,EAAqB,SAACC,EAASC,GAC1C,IAAMC,EAAYF,EAAQH,GAC1B,IAAKK,EACH,UAAUC,MAAM,+CAElB,IAAMC,EAAcC,EAAMC,WAAW,SAAAC,UAASA,EAAQ,GAAG,GAAG,GACtDC,EAAQH,EAAMI,WAAWT,GACzBU,EAAWT,EAASO,GACpBG,EAAMN,EAAMO,OAAO,MAqBzB,OApBAP,EAAMQ,gBAAgB,WACpBF,EAAIG,QAAU,CAAEb,SAAAA,EAAUO,MAAAA,EAAOE,SAAAA,KAEnCL,EAAMQ,gBAAgB,WACpB,IAAME,EAAW,SAACC,GAChB,IACE,GAAIL,EAAIG,QAAQN,QAAUQ,GACrBC,OAAOC,GAAGP,EAAIG,QAAQJ,SAAUC,EAAIG,QAAQb,SAASe,IACxD,OAEF,MAAOG,IAGTf,KAGF,OADAF,EAAUkB,IAAIL,cAEZb,EAAUmB,OAAON,KAElB,CAACX,EAAaF,IACVQ,yBA1CoB,SAACY,GAC5B,IAdsBC,EAAcrB,EAc9BF,EAAUK,EAAMmB,cAAcF,EAAc,sBAOlD,OALAtB,EAAQH,GAAqB,IAAI4B,IAEjCzB,EAAQ0B,UAlBcH,EAkBYvB,EAAQ0B,SAlBNxB,EAkBgBF,EAAQH,GAlBVQ,EAAMsB,KAAK,gBAAGnB,IAAAA,MAAOoB,IAAAA,SAQvE,OAHA1B,EAAU2B,KAAK,SAAAC,GACbA,EAAStB,KAEJH,EAAM0B,cAAcR,EAAc,CAAEf,MAAAA,GAASoB,aAY7C5B,EAAQgC,SACRhC,sBAuCiB,SAAAA,UAAWD,EAAmBC,EAAS,SAAAiC,UAAKA"}
{"version":3,"file":"index.esm.js","sources":["../src/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/ban-ts-ignore */\n\nimport {\n  Context,\n  FC,\n  MutableRefObject,\n  Provider,\n  createElement,\n  createContext as createContextOrig,\n  // @ts-ignore\n  createMutableSource,\n  memo,\n  useCallback,\n  useContext as useContextOrig,\n  useLayoutEffect,\n  useEffect,\n  useMemo,\n  // @ts-ignore\n  useMutableSource,\n  useRef,\n} from 'react';\nimport {\n  unstable_UserBlockingPriority as UserBlockingPriority,\n  unstable_NormalPriority as NormalPriority,\n  unstable_runWithPriority as runWithPriority,\n} from 'scheduler';\n\nconst isClient = (\n  typeof window !== 'undefined'\n  && !/ServerSideRendering/.test(window.navigator && window.navigator.userAgent)\n);\n\nconst useIsomorphicLayoutEffect = isClient ? useLayoutEffect : useEffect;\n\nconst SOURCE_SYMBOL = Symbol();\nconst VALUE_PROP = 'v';\nconst LISTENERS_PROP = 'l';\n\n// @ts-ignore\ntype ContextValue<Value> = {\n  [SOURCE_SYMBOL]: any;\n};\n\nconst createProvider = <Value>(ProviderOrig: Provider<ContextValue<Value>>) => {\n  const RefProvider: FC<{ value: Value }> = ({ value, children }) => {\n    const ref = useRef({\n      [VALUE_PROP]: value,\n      [LISTENERS_PROP]: new Set<() => void>(),\n    });\n    useIsomorphicLayoutEffect(() => {\n      ref.current[VALUE_PROP] = value;\n      runWithPriority(NormalPriority, () => {\n        ref.current[LISTENERS_PROP].forEach((listener) => listener());\n      });\n    });\n    const contextValue = useMemo(() => ({\n      [SOURCE_SYMBOL]: createMutableSource(ref, () => ref.current[VALUE_PROP]),\n    }), []);\n    return createElement(ProviderOrig, { value: contextValue }, children);\n  };\n  return memo(RefProvider);\n};\n\nconst identity = <T>(x: T) => x;\n\n/**\n * This creates a special context for selector-enabled `useContext`.\n *\n * It doesn't pass its value but a ref of the value.\n * Unlike the original context provider, this context provider\n * expects the context value to be immutable and stable.\n *\n * @example\n * import { createContext } from 'use-context-selector';\n *\n * const PersonContext = createContext({ firstName: '', familyName: '' });\n */\nexport function createContext<Value>(defaultValue: Value) {\n  const source = createMutableSource({ current: defaultValue }, () => defaultValue);\n  const context = createContextOrig(\n    { [SOURCE_SYMBOL]: source },\n  ) as unknown as Context<Value>; // HACK typing\n  context.Provider = createProvider(\n    context.Provider as unknown as Provider<ContextValue<Value>>, // HACK typing\n  ) as Provider<Value>;\n  delete context.Consumer; // no support for Consumer\n  return context;\n}\n\nconst subscribe = (\n  ref: MutableRefObject<{ [LISTENERS_PROP]: Set<() => void> }>,\n  callback: () => void,\n) => {\n  const listeners = ref.current[LISTENERS_PROP];\n  listeners.add(callback);\n  return () => listeners.delete(callback);\n};\n\nexport function useContext<Value>(context: Context<Value>): Value;\nexport function useContext<Value, Selected>(\n  context: Context<Value>,\n  selector: (value: Value) => Selected,\n): Selected;\n\n/**\n * This hook returns context value with optional selector.\n *\n * It will only accept context created by `createContext`.\n * It will trigger re-render if only the selected value is referentially changed.\n * The selector must be stable.\n * Either define selector outside render or wrap with `useCallback`.\n *\n * The selector should return referentially equal result for same input for better performance.\n *\n * @example\n * import { useContext } from 'use-context-selector';\n *\n * const firstName = useContext(PersonContext, state => state.firstName);\n */\nexport function useContext<Value, Selected>(\n  context: Context<Value>,\n  selector: (value: Value) => Selected = identity as (value: Value) => Selected,\n) {\n  const { [SOURCE_SYMBOL]: source } = useContextOrig(\n    context,\n  ) as unknown as ContextValue<Value>; // HACK typing\n  if (process.env.NODE_ENV !== 'production') {\n    if (!source) {\n      throw new Error('This useContext requires special context for selector support');\n    }\n  }\n  const getSnapshot = useCallback(\n    (ref: MutableRefObject<{ [VALUE_PROP]: Value }>) => selector(ref.current[VALUE_PROP]),\n    [selector],\n  );\n  return useMutableSource(source, getSnapshot, subscribe);\n}\n\ntype AnyCallback = (...args: any) => any;\n\n/**\n * A utility function to wrap a callback function with higher priority\n *\n * Use this for a callback that will change a value,\n * which will be fed into context provider.\n *\n * @example\n * import { wrapCallbackWithPriority } from 'use-context-selector';\n *\n * const wrappedCallback = wrapCallbackWithPriority(callback);\n */\nexport function wrapCallbackWithPriority<Callback extends AnyCallback>(callback: Callback) {\n  const callbackWithPriority = (...args: any) => (\n    runWithPriority(UserBlockingPriority, () => callback(...args))\n  );\n  return callbackWithPriority as Callback;\n}\n"],"names":["useIsomorphicLayoutEffect","window","test","navigator","userAgent","useEffect","useLayoutEffect","SOURCE_SYMBOL","Symbol","identity","x","createContext","defaultValue","ProviderOrig","source","createMutableSource","current","context","createContextOrig","Provider","memo","value","children","ref","useRef","Set","runWithPriority","NormalPriority","forEach","listener","contextValue","useMemo","createElement","Consumer","subscribe","callback","listeners","add","useContext","selector","useContextOrig","process","env","NODE_ENV","Error","getSnapshot","useCallback","useMutableSource","wrapCallbackWithPriority","args","UserBlockingPriority"],"mappings":"qUA2BA,IAKMA,EAJc,oBAAXC,QACH,sBAAsBC,KAAKD,OAAOE,WAAaF,OAAOE,UAAUC,WAGPC,EAAlBC,EAEvCC,EAAgBC,SA6BhBC,EAAW,SAAIC,UAASA,YAcdC,EAAqBC,SAlCNC,EAmCvBC,EAASC,EAAoB,CAAEC,QAASJ,GAAgB,kBAAMA,IAC9DK,EAAUC,UACXX,GAAgBO,MAMrB,OAJAG,EAAQE,UAvCqBN,EAwC3BI,EAAQE,SAvBHC,EAhBmC,kBAAGC,IAAAA,MAAOC,IAAAA,SAC5CC,EAAMC,UAAM,EACFH,IADE,EAEE,IAAII,QAExBzB,EAA0B,WACxBuB,EAAIP,QAAJ,EAA0BK,EAC1BK,EAAgBC,EAAgB,WAC9BJ,EAAIP,QAAJ,EAA4BY,QAAQ,SAACC,UAAaA,UAGtD,IAAMC,EAAeC,EAAQ,8BAC1BxB,GAAgBQ,EAAoBQ,EAAK,kBAAMA,EAAIP,QAAJ,OAC9C,IACJ,OAAOgB,EAAcnB,EAAc,CAAEQ,MAAOS,GAAgBR,aA2BvDL,EAAQgB,SACRhB,EAGT,IAAMiB,EAAY,SAChBX,EACAY,GAEA,IAAMC,EAAYb,EAAIP,QAAJ,EAElB,OADAoB,EAAUC,IAAIF,qBACDC,SAAiBD,cAwBhBG,EACdrB,EACAsB,YAAAA,IAAAA,EAAuC9B,OAEdK,EAAW0B,EAClCvB,GADOV,GAGT,GAA6B,eAAzBkC,QAAQC,IAAIC,WACT7B,EACH,UAAU8B,MAAM,iEAGpB,IAAMC,EAAcC,EAClB,SAACvB,UAAmDgB,EAAShB,EAAIP,QAAJ,IAC7D,CAACuB,IAEH,OAAOQ,EAAiBjC,EAAQ+B,EAAaX,YAgB/Bc,EAAuDb,GAIrE,OAH6B,sCAAIc,2BAAAA,yBAC/BvB,EAAgBwB,EAAsB,kBAAMf,eAAYc"}
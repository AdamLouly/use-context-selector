{"version":3,"file":"index.umd.js","sources":["../src/index.js"],"sourcesContent":["import React from 'react';\n\nconst CONTEXT_LISTENERS = (\n  process.env.NODE_ENV !== 'production' ? Symbol('CONTEXT_LISTENERS')\n  /* for production */ : Symbol()\n);\n\nconst createProvider = (OrigProvider, listeners) => React.memo(({ value, children }) => {\n  // we call listeners in render intentionally.\n  // listeners are not technically pure, but\n  // otherwise we can't get benefits from concurrent mode.\n  // we make sure to work with double or more invocation of listeners.\n  listeners.forEach((listener) => {\n    listener(value);\n  });\n  return React.createElement(OrigProvider, { value }, children);\n});\n\n/**\n * This creates a special context for `useContextSelector`.\n * @param {*} defaultValue\n * @returns {React.Context}\n * @example\n * const PersonContext = createContext({ firstName: '', familyName: '' });\n */\nexport const createContext = (defaultValue) => {\n  // make changedBits always zero\n  const context = React.createContext(defaultValue, () => 0);\n  // shared listeners (not ideal)\n  context[CONTEXT_LISTENERS] = new Set();\n  // hacked provider\n  context.Provider = createProvider(context.Provider, context[CONTEXT_LISTENERS]);\n  // no support for consumer\n  delete context.Consumer;\n  return context;\n};\n\n/**\n * This hook returns context selected value by selector.\n * It will only accept context created by `createContext`.\n * It will trigger re-render if only the selected value is referencially changed.\n * @param {React.Context} context\n * @param {Function} selector\n * @returns {*}\n * @example\n * const firstName = useContextSelector(PersonContext, state => state.firstName);\n */\nexport const useContextSelector = (context, selector) => {\n  const listeners = context[CONTEXT_LISTENERS];\n  if (!listeners) {\n    if (process.env.NODE_ENV !== 'production') {\n      throw new Error('useContextSelector requires special context');\n    } else {\n      // for production\n      throw new Error();\n    }\n  }\n  const [, forceUpdate] = React.useReducer(c => c + 1, 0);\n  const value = React.useContext(context);\n  const selected = selector(value);\n  const ref = React.useRef(null);\n  React.useLayoutEffect(() => {\n    ref.current = {\n      f: selector, // last selector \"f\"unction\n      v: value, // last \"v\"alue\n      s: selected, // last \"s\"elected value\n    };\n  });\n  React.useLayoutEffect(() => {\n    const callback = (nextValue) => {\n      try {\n        if (ref.current.v === nextValue\n          || Object.is(ref.current.s, ref.current.f(nextValue))) {\n          return;\n        }\n      } catch (e) {\n        // ignored (stale props or some other reason)\n      }\n      forceUpdate();\n    };\n    listeners.add(callback);\n    return () => {\n      listeners.delete(callback);\n    };\n  }, [listeners]);\n  return selected;\n};\n\n/**\n * This hook returns the entire context value.\n * Use this instead of React.useContext for consistent behavior.\n * @param {React.Context} context\n * @returns {*}\n * @example\n * const person = useContext(PersonContext);\n */\n// this is not best implemented for performance,\n// but this wouldn't be used very often.\nexport const useContext = context => useContextSelector(context, x => x);\n"],"names":["CONTEXT_LISTENERS","process","env","NODE_ENV","Symbol","useContextSelector","context","selector","listeners","Error","forceUpdate","React","useReducer","c","value","useContext","selected","ref","useRef","useLayoutEffect","current","f","v","s","callback","nextValue","Object","is","e","add","delete","defaultValue","OrigProvider","createContext","Set","Provider","memo","children","forEach","listener","createElement","Consumer","x"],"mappings":"mRAEA,IAAMA,EACqB,eAAzBC,QAAQC,IAAIC,SAA4BC,OAAO,qBACxBA,SA2CZC,EAAqB,SAACC,EAASC,GAC1C,IAAMC,EAAYF,EAAQN,GAC1B,IAAKQ,EACH,KAA6B,eAAzBP,QAAQC,IAAIC,aACJM,MAAM,mDAGNA,MAPyC,IAU9CC,EAAeC,EAAMC,YAAW,SAAAC,UAAKA,EAAI,IAAG,MAC/CC,EAAQH,EAAMI,WAAWT,GACzBU,EAAWT,EAASO,GACpBG,EAAMN,EAAMO,OAAO,MAyBzB,OAxBAP,EAAMQ,iBAAgB,WACpBF,EAAIG,QAAU,CACZC,EAAGd,EACHe,EAAGR,EACHS,EAAGP,MAGPL,EAAMQ,iBAAgB,WACpB,IAAMK,EAAW,SAACC,GAChB,IACE,GAAIR,EAAIG,QAAQE,IAAMG,GACjBC,OAAOC,GAAGV,EAAIG,QAAQG,EAAGN,EAAIG,QAAQC,EAAEI,IAC1C,OAEF,MAAOG,IAGTlB,KAGF,OADAF,EAAUqB,IAAIL,cAEZhB,EAAUsB,OAAON,MAElB,CAAChB,IACGQ,mBA5DoB,SAACe,GAE5B,IApBsBC,EAAcxB,EAoB9BF,EAAUK,EAAMsB,cAAcF,GAAc,uBAOlD,OALAzB,EAAQN,GAAqB,IAAIkC,IAEjC5B,EAAQ6B,UAxBcH,EAwBY1B,EAAQ6B,SAxBN3B,EAwBgBF,EAAQN,GAxBVW,EAAMyB,MAAK,gBAAGtB,IAAAA,MAAOuB,IAAAA,SAQvE,OAHA7B,EAAU8B,SAAQ,SAACC,GACjBA,EAASzB,MAEJH,EAAM6B,cAAcR,EAAc,CAAElB,MAAAA,GAASuB,cAkB7C/B,EAAQmC,SACRnC,gBAgEiB,SAAAA,UAAWD,EAAmBC,GAAS,SAAAoC,UAAKA"}
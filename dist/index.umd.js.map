{"version":3,"file":"index.umd.js","sources":["../src/index.js"],"sourcesContent":["import React from 'react';\r\n\r\n// utils\r\n\r\nconst forcedReducer = state => state + 1;\r\nconst useForceUpdate = () => React.useReducer(forcedReducer, 0)[1];\r\n\r\nconst calculateChangedBits = () => 0;\r\n\r\nconst identity = x => x;\r\n\r\nconst CONTEXT_LISTENERS = Symbol('CONTEXT_LISTENERS');\r\n\r\nconst createProvider = (OrigProvider, listeners) => React.memo(({ value, children }) => {\r\n  React.useLayoutEffect(() => {\r\n    listeners.forEach(listener => listener(value));\r\n  }, [value]);\r\n  return React.createElement(OrigProvider, { value }, children);\r\n});\r\n\r\n// createContext\r\n\r\nexport const createContext = (defaultValue) => {\r\n  const context = React.createContext(defaultValue, calculateChangedBits);\r\n  const listeners = new Set();\r\n  // shared listeners (not ideal)\r\n  context[CONTEXT_LISTENERS] = listeners;\r\n  // hacked provider\r\n  context.Provider = createProvider(context.Provider, listeners);\r\n  // no support for consumer\r\n  delete context.Consumer;\r\n  return context;\r\n};\r\n\r\n// useContextSelector\r\n\r\nexport const useContextSelector = (context, selector) => {\r\n  const listeners = context[CONTEXT_LISTENERS];\r\n  if (!listeners) {\r\n    throw new Error('useContextSelector requires special context');\r\n  }\r\n  const forceUpdate = useForceUpdate();\r\n  const value = React.useContext(context);\r\n  const selected = selector(value);\r\n  const ref = React.useRef(null);\r\n  React.useLayoutEffect(() => {\r\n    ref.current = { selector, value, selected };\r\n  });\r\n  React.useLayoutEffect(() => {\r\n    const callback = (nextValue) => {\r\n      try {\r\n        if (ref.current.value === nextValue\r\n          || Object.is(ref.current.selected, ref.current.selector(nextValue))) {\r\n          return;\r\n        }\r\n      } catch (e) {\r\n        // ignored (stale props or some other reason)\r\n      }\r\n      ref.current.value = nextValue;\r\n      forceUpdate();\r\n    };\r\n    listeners.add(callback);\r\n    return () => {\r\n      listeners.delete(callback);\r\n    };\r\n  }, [forceUpdate, listeners]);\r\n  return selected;\r\n};\r\n\r\n// useContext\r\n\r\nexport const useContext = context => useContextSelector(context, identity);\r\n"],"names":["const","forcedReducer","state","useForceUpdate","React","useReducer","calculateChangedBits","identity","x","CONTEXT_LISTENERS","Symbol","createProvider","OrigProvider","listeners","memo","children","useLayoutEffect","forEach","listener","value","createElement","createContext","defaultValue","context","Set","Provider","Consumer","useContextSelector","selector","Error","forceUpdate","useContext","selected","ref","useRef","current","callback","nextValue","Object","is","e","add","delete"],"mappings":";;;;;;;EAIAA,IAAMC,aAAa,aAAGC,gBAASA,KAAK,GAAG,IAAvC;;EACAF,IAAMG,cAAc,wBAASC,KAAK,CAACC,UAAN,CAAiBJ,aAAjB,EAAgC,CAAhC,EAAmC,CAAnC,IAA7B;;EAEAD,IAAMM,oBAAoB,wBAAS,IAAnC;;EAEAN,IAAMO,QAAQ,aAAGC,YAAKA,IAAtB;;EAEAR,IAAMS,iBAAiB,GAAGC,MAAM,CAAC,mBAAD,CAAhC;;EAEAV,IAAMW,cAAc,aAAIC,YAAD,EAAeC,SAAf,WAA6BT,KAAK,CAACU,IAAN,WAAY,GAAD;0BAAUC;;;IACvEX,KAAK,CAACY,eAAN;MACEH,SAAS,CAACI,OAAV,WAAkBC,mBAAYA,QAAQ,CAACC,KAAD,IAAtC;KADF,EAEG,CAACA,KAAD,CAFH;WAGOf,KAAK,CAACgB,aAAN,CAAoBR,YAApB,EAAkC;aAAEO;KAApC,EAA6CJ,QAA7C,CAAP;GAJkD,IAApD;;;AASA,MAAaM,aAAa,aAAIC;QACtBC,OAAO,GAAGnB,KAAK,CAACiB,aAAN,CAAoBC,YAApB,EAAkChB,oBAAlC,CAAhB;QACMO,SAAS,GAAG,IAAIW,GAAJ,EAAlB,CAF6C;;IAI7CD,OAAO,CAACd,iBAAD,CAAP,GAA6BI,SAA7B,CAJ6C;;IAM7CU,OAAO,CAACE,QAAR,GAAmBd,cAAc,CAACY,OAAO,CAACE,QAAT,EAAmBZ,SAAnB,CAAjC,CAN6C;;WAQtCU,OAAO,CAACG,QAAf;WACOH,OAAP;GATK;;AAcP,MAAaI,kBAAkB,aAAIJ,OAAD,EAAUK,QAAV;QAC1Bf,SAAS,GAAGU,OAAO,CAACd,iBAAD,CAAzB;;QACI,CAACI,SAAL,EAAgB;YACR,IAAIgB,KAAJ,CAAU,6CAAV,CAAN;;;QAEIC,WAAW,GAAG3B,cAAc,EAAlC;QACMgB,KAAK,GAAGf,KAAK,CAAC2B,UAAN,CAAiBR,OAAjB,CAAd;QACMS,QAAQ,GAAGJ,QAAQ,CAACT,KAAD,CAAzB;QACMc,GAAG,GAAG7B,KAAK,CAAC8B,MAAN,CAAa,IAAb,CAAZ;IACA9B,KAAK,CAACY,eAAN;MACEiB,GAAG,CAACE,OAAJ,GAAc;kBAAEP,QAAF;eAAYT,KAAZ;kBAAmBa;OAAjC;KADF;IAGA5B,KAAK,CAACY,eAAN;UACQoB,QAAQ,aAAIC;YACZ;cACEJ,GAAG,CAACE,OAAJ,CAAYhB,KAAZ,KAAsBkB,SAAtB,IACCC,MAAM,CAACC,EAAP,CAAUN,GAAG,CAACE,OAAJ,CAAYH,QAAtB,EAAgCC,GAAG,CAACE,OAAJ,CAAYP,QAAZ,CAAqBS,SAArB,CAAhC,CADL,EACuE;;;SAFzE,CAKE,OAAOG,CAAP,EAAU;;;QAGZP,GAAG,CAACE,OAAJ,CAAYhB,KAAZ,GAAoBkB,SAApB;QACAP,WAAW;OAVb;;MAYAjB,SAAS,CAAC4B,GAAV,CAAcL,QAAd;;QAEEvB,SAAS,CAAC6B,MAAV,CAAiBN,QAAjB;OADF;KAdF,EAiBG,CAACN,WAAD,EAAcjB,SAAd,CAjBH;WAkBOmB,QAAP;GA9BK;;AAmCP,MAAaD,UAAU,aAAGR,kBAAWI,kBAAkB,CAACJ,OAAD,EAAUhB,QAAV,IAAhD;;;;;;;;;;"}
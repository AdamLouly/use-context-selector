{"version":3,"file":"index.umd.js","sources":["../src/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/ban-ts-ignore */\n\nimport {\n  ComponentType,\n  Context as ContextOrig,\n  FC,\n  MutableRefObject,\n  Provider,\n  createElement,\n  createContext as createContextOrig,\n  // @ts-ignore\n  createMutableSource,\n  memo,\n  useCallback,\n  useContext as useContextOrig,\n  useLayoutEffect,\n  useEffect,\n  useMemo,\n  // @ts-ignore\n  useMutableSource,\n  useRef,\n} from 'react';\nimport {\n  unstable_UserBlockingPriority as UserBlockingPriority,\n  unstable_NormalPriority as NormalPriority,\n  unstable_runWithPriority as runWithPriority,\n} from 'scheduler';\n\nconst isClient = (\n  typeof window !== 'undefined'\n  && !/ServerSideRendering/.test(window.navigator && window.navigator.userAgent)\n);\n\nconst useIsomorphicLayoutEffect = isClient ? useLayoutEffect : useEffect;\n\nconst SOURCE_SYMBOL = Symbol();\nconst VALUE_PROP = 'v';\nconst LISTENERS_PROP = 'l';\n\n// @ts-ignore\ntype ContextValue<Value> = {\n  [SOURCE_SYMBOL]: any;\n};\n\nexport interface Context<Value> {\n  Provider: ComponentType<{ value: Value }>;\n  displayName?: string;\n}\n\nconst createProvider = <Value>(ProviderOrig: Provider<ContextValue<Value>>) => {\n  const RefProvider: FC<{ value: Value }> = ({ value, children }) => {\n    const ref = useRef({\n      [VALUE_PROP]: value,\n      [LISTENERS_PROP]: new Set<() => void>(),\n    });\n    useIsomorphicLayoutEffect(() => {\n      ref.current[VALUE_PROP] = value;\n      runWithPriority(NormalPriority, () => {\n        ref.current[LISTENERS_PROP].forEach((listener) => listener());\n      });\n    });\n    const contextValue = useMemo(() => ({\n      [SOURCE_SYMBOL]: createMutableSource(ref, () => ref.current[VALUE_PROP]),\n    }), []);\n    return createElement(ProviderOrig, { value: contextValue }, children);\n  };\n  return memo(RefProvider);\n};\n\nconst identity = <T>(x: T) => x;\n\n/**\n * This creates a special context for selector-enabled `useContext`.\n *\n * It doesn't pass its value but a ref of the value.\n * Unlike the original context provider, this context provider\n * expects the context value to be immutable and stable.\n *\n * @example\n * import { createContext } from 'use-context-selector';\n *\n * const PersonContext = createContext({ firstName: '', familyName: '' });\n */\nexport function createContext<Value>(defaultValue: Value) {\n  const source = createMutableSource({ current: defaultValue }, () => defaultValue);\n  const context = createContextOrig({ [SOURCE_SYMBOL]: source });\n  (context as unknown as Context<Value>).Provider = createProvider(context.Provider);\n  delete context.Consumer; // no support for Consumer\n  return context as unknown as Context<Value>;\n}\n\nconst subscribe = (\n  ref: MutableRefObject<{ [LISTENERS_PROP]: Set<() => void> }>,\n  callback: () => void,\n) => {\n  const listeners = ref.current[LISTENERS_PROP];\n  listeners.add(callback);\n  return () => listeners.delete(callback);\n};\n\nexport function useContext<Value>(context: Context<Value>): Value;\nexport function useContext<Value, Selected>(\n  context: Context<Value>,\n  selector: (value: Value) => Selected,\n): Selected;\n\n/**\n * This hook returns context value with optional selector.\n *\n * It will only accept context created by `createContext`.\n * It will trigger re-render if only the selected value is referentially changed.\n * The selector must be stable.\n * Either define selector outside render or wrap with `useCallback`.\n *\n * The selector should return referentially equal result for same input for better performance.\n *\n * @example\n * import { useContext } from 'use-context-selector';\n *\n * const firstName = useContext(PersonContext, state => state.firstName);\n */\nexport function useContext<Value, Selected>(\n  context: Context<Value>,\n  selector: (value: Value) => Selected = identity as (value: Value) => Selected,\n) {\n  const { [SOURCE_SYMBOL]: source } = useContextOrig(\n    context as unknown as ContextOrig<ContextValue<Value>>,\n  );\n  if (process.env.NODE_ENV !== 'production') {\n    if (!source) {\n      throw new Error('This useContext requires special context for selector support');\n    }\n  }\n  const getSnapshot = useCallback(\n    (ref: MutableRefObject<{ [VALUE_PROP]: Value }>) => selector(ref.current[VALUE_PROP]),\n    [selector],\n  );\n  return useMutableSource(source, getSnapshot, subscribe);\n}\n\ntype AnyCallback = (...args: any) => any;\n\n/**\n * A utility function to wrap a callback function with higher priority\n *\n * Use this for a callback that will change a value,\n * which will be fed into context provider.\n *\n * @example\n * import { wrapCallbackWithPriority } from 'use-context-selector';\n *\n * const wrappedCallback = wrapCallbackWithPriority(callback);\n */\nexport function wrapCallbackWithPriority<Callback extends AnyCallback>(callback: Callback) {\n  const callbackWithPriority = (...args: any) => (\n    runWithPriority(UserBlockingPriority, () => callback(...args))\n  );\n  return callbackWithPriority as Callback;\n}\n"],"names":["useIsomorphicLayoutEffect","window","test","navigator","userAgent","useEffect","useLayoutEffect","SOURCE_SYMBOL","Symbol","identity","x","subscribe","ref","callback","listeners","current","add","defaultValue","ProviderOrig","source","createMutableSource","context","createContextOrig","Provider","memo","value","children","useRef","Set","runWithPriority","NormalPriority","forEach","listener","contextValue","useMemo","createElement","Consumer","selector","useContextOrig","process","env","NODE_ENV","Error","getSnapshot","useCallback","useMutableSource","args","UserBlockingPriority"],"mappings":"oRA4BA,IAKMA,EAJc,oBAAXC,QACH,sBAAsBC,KAAKD,OAAOE,WAAaF,OAAOE,UAAUC,WAGPC,YAAlBC,kBAEvCC,EAAgBC,SAkChBC,EAAW,SAAIC,UAASA,GAsBxBC,EAAY,SAChBC,EACAC,GAEA,IAAMC,EAAYF,EAAIG,QAAJ,EAElB,OADAD,EAAUE,IAAIH,qBACDC,SAAiBD,8BAdKI,SAlCNC,EAmCvBC,EAASC,sBAAoB,CAAEL,QAASE,GAAgB,kBAAMA,IAC9DI,EAAUC,wBAAqBf,GAAgBY,MAGrD,OAFCE,EAAsCE,UArCVL,EAqCoCG,EAAQE,SApBlEC,OAhBmC,kBAAGC,IAAAA,MAAOC,IAAAA,SAC5Cd,EAAMe,iBAAM,EACFF,IADE,EAEE,IAAIG,QAExB5B,EAA0B,WACxBY,EAAIG,QAAJ,EAA0BU,EAC1BI,2BAAgBC,0BAAgB,WAC9BlB,EAAIG,QAAJ,EAA4BgB,QAAQ,SAACC,UAAaA,UAGtD,IAAMC,EAAeC,UAAQ,8BAC1B3B,GAAgBa,sBAAoBR,EAAK,kBAAMA,EAAIG,QAAJ,OAC9C,IACJ,OAAOoB,gBAAcjB,EAAc,CAAEO,MAAOQ,GAAgBP,aAuBvDL,EAAQe,SACRf,yBAkCPA,EACAgB,YAAAA,IAAAA,EAAuC5B,OAEdU,EAAWmB,aAClCjB,GADOd,GAGT,GAA6B,eAAzBgC,QAAQC,IAAIC,WACTtB,EACH,UAAUuB,MAAM,iEAGpB,IAAMC,EAAcC,cAClB,SAAChC,UAAmDyB,EAASzB,EAAIG,QAAJ,IAC7D,CAACsB,IAEH,OAAOQ,mBAAiB1B,EAAQwB,EAAahC,wCAgBwBE,GAIrE,OAH6B,sCAAIiC,2BAAAA,yBAC/BjB,2BAAgBkB,gCAAsB,kBAAMlC,eAAYiC"}